#!/bin/bash

# Pre-commit hook for formatting and static checks
# Supports TypeScript, JavaScript, Rust, and configuration files

set -e

# Source utilities
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
source "$SCRIPT_DIR/common/utils.sh"

# Get project root
PROJECT_ROOT=$(get_project_root)
cd "$PROJECT_ROOT"

log_info "üöÄ Running pre-commit checks..."

# Initialize exit code
exit_code=0

# Get staged files by type
ts_js_files=$(get_staged_files '\.(ts|tsx|js|jsx)$')
rust_files=$(get_staged_files '\.rs$')
config_files=$(get_staged_files '\.(toml|json|yaml|yml|md)$')

log_info "üìÅ Found staged files:"
[[ -n "$ts_js_files" ]] && log_info "  ‚Ä¢ TypeScript/JavaScript: $(echo "$ts_js_files" | wc -l | tr -d ' ') files"
[[ -n "$rust_files" ]] && log_info "  ‚Ä¢ Rust: $(echo "$rust_files" | wc -l | tr -d ' ') files"
[[ -n "$config_files" ]] && log_info "  ‚Ä¢ Config files: $(echo "$config_files" | wc -l | tr -d ' ') files"

# 1. TypeScript/JavaScript - Format and Lint with Biome
if [[ -n "$ts_js_files" ]]; then
    echo
    log_step "üìù TypeScript/JavaScript: Biome format and lint"

    # Check Biome command availability
    if command_exists pnpm; then
        biome_cmd="pnpm biome"
    elif command_exists npm; then
        biome_cmd="npm run biome"
    elif command_exists biome; then
        biome_cmd="biome"
    else
        log_error "Biome not found. Please install it or ensure it's available in package.json"
        exit_code=1
    fi

    if [[ $exit_code -eq 0 ]]; then
        # Run Biome check and format
        if ! $biome_cmd check --write $ts_js_files; then
            log_error "Biome check failed for TypeScript/JavaScript files"
            exit_code=1
        fi
    fi
fi

# 2. Rust - Format and Lint
if [[ -n "$rust_files" ]]; then
    echo
    log_step "ü¶Ä Rust: Format and lint"

    # Change to src-tauri directory for Rust commands
    cd "$PROJECT_ROOT/src-tauri"

    # Check if rustfmt is available
    if command_exists cargo; then
        # Format with rustfmt (run on entire project)
        log_step "Rust: Formatting with rustfmt"
        if ! cargo fmt --all -- --check; then
            log_warning "Rust files not properly formatted, formatting now..."
            cargo fmt --all
            # Don't fail here, just format and continue
        fi

        # Lint with clippy (non-blocking due to SQLX dependencies)
        log_step "Rust: Linting with clippy"
        if ! cargo clippy --all-targets --all-features; then
            log_warning "Clippy found issues in Rust files (non-blocking due to SQLX dependencies)"
            log_warning "Consider running 'pnpm check' manually when database is available"
        fi
    else
        log_error "Cargo not found. Please install Rust"
        exit_code=1
    fi

    # Return to project root
    cd "$PROJECT_ROOT"
fi

# 3. Configuration Files - Format only
if [[ -n "$config_files" ]]; then
    echo
    log_step "‚öôÔ∏è  Configuration files: Format only"

    for file in $config_files; do
        if [[ -f "$file" ]]; then
            case "$file" in
                *.json)
                    # Use Biome for JSON formatting if available, otherwise fallback
                    if command_exists pnpm; then
                        pnpm biome format --write "$file" && log_info "Formatted JSON: $file"
                    elif command_exists npm; then
                        npm run biome -- format --write "$file" && log_info "Formatted JSON: $file"
                    elif command_exists biome; then
                        biome format --write "$file" && log_info "Formatted JSON: $file"
                    elif command_exists jq; then
                        jq '.' "$file" > "$file.tmp" && mv "$file.tmp" "$file" && log_info "Formatted JSON: $file"
                    fi
                    ;;
                *.yaml|*.yml)
                    if command_exists yq; then
                        yq eval '.' "$file" > "$file.tmp" && mv "$file.tmp" "$file" && log_info "Formatted YAML: $file"
                    fi
                    ;;
                *.toml)
                    # TOML files are usually well-formatted by tools that generate them
                    log_info "TOML file: $file (no formatting applied)"
                    ;;
                *.md)
                    # Use Biome for Markdown formatting if available
                    if command_exists pnpm; then
                        pnpm biome format --write "$file" && log_info "Formatted Markdown: $file"
                    elif command_exists npm; then
                        npm run biome -- format --write "$file" && log_info "Formatted Markdown: $file"
                    elif command_exists biome; then
                        biome format --write "$file" && log_info "Formatted Markdown: $file"
                    elif command_exists prettier; then
                        prettier --write "$file" && log_info "Formatted Markdown: $file"
                    fi
                    ;;
            esac
        fi
    done
fi

# 4. TypeScript Type Checking
if [[ -n "$ts_js_files" ]]; then
    echo
    log_step "üîç TypeScript: Type checking"

    if command_exists pnpm; then
        if ! pnpm tsc --noEmit; then
            log_error "TypeScript type checking failed"
            exit_code=1
        fi
    elif command_exists npm; then
        if ! npm run lint; then
            log_error "TypeScript type checking failed"
            exit_code=1
        fi
    elif command_exists tsc; then
        if ! tsc --noEmit; then
            log_error "TypeScript type checking failed"
            exit_code=1
        fi
    else
        log_warning "TypeScript compiler not found, skipping type checking"
    fi
fi

# 5. Re-stage formatted files
restage_formatted_files

# Final result
echo
if [[ $exit_code -eq 0 ]]; then
    log_success "‚úÖ All pre-commit checks passed!"
else
    log_error "‚ùå Pre-commit checks failed. Please fix the issues above and try again."
    echo
    log_info "üí° To bypass hooks temporarily: git config core.hooksPath \"\""
fi

exit $exit_code